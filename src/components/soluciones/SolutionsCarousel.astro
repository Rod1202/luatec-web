---
import { Icon } from 'astro-icon/components';
---

<section class="carousel-section overflow-hidden bg-transparent py-16 md:py-24" id="soluciones">
  <div class="max-w-7xl mx-auto px-6">
    <div class="text-center mb-12">
      <h2 class="text-3xl md:text-5xl font-bold text-white mb-4">Nuestras Soluciones</h2>
    </div>

  <div class="carousel-wrapper relative overflow-hidden py-8">
    <div class="carousel-track flex transition-transform duration-500 ease-[cubic-bezier(0.4,0,0.2,1)] will-change-transform items-center" id="track">

      <!-- 1. Cloud e Infraestructura -->
      <div class="card bg-[#0a1a2e]/90 backdrop-blur-xl border border-white/5 p-10 md:p-14 relative overflow-hidden cursor-pointer" data-index="0">
        <div class="absolute -right-4 -bottom-10 text-[12rem] font-bold text-white/5 select-none pointer-events-none z-0 leading-none">01</div>
        
        <div class="relative z-10 flex flex-col h-full">
          <div class="flex flex-col md:flex-row md:items-center gap-6 mb-8">
            <div class="w-16 h-16 bg-blue-600 rounded-2xl flex items-center justify-center shrink-0 shadow-lg shadow-blue-600/20">
              <span class="material-symbols-outlined text-white text-3xl">cloud_done</span>
            </div>
            <div class="flex flex-col">
              <h3 class="text-2xl md:text-4xl font-bold text-white leading-tight">Cloud e Infraestructura</h3>
              <p class="text-[0.7rem] md:text-[0.8rem] font-bold uppercase tracking-wider text-blue-500 mt-1">Escalabilidad Infinita</p>
            </div>
          </div>

          <p class="text-slate-300 text-sm md:text-lg leading-relaxed font-light mb-8 max-w-sm">
            Diseñamos y operamos arquitecturas de nube híbrida y multicloud que garantizan escalabilidad robusta y alta disponibilidad.
          </p>
          
          <a href="/formulario" class="card-link inline-flex items-center gap-2 text-sm font-semibold text-blue-500 no-underline transition-all hover:gap-3">
            Solicitar Información <span class="material-symbols-outlined text-sm">arrow_forward</span>
          </a>
        </div>
      </div>

      <!-- 2. Ciberseguridad Avanzada -->
      <div class="card bg-[#0a1a2e]/90 backdrop-blur-xl border border-white/5 p-10 md:p-14 relative overflow-hidden cursor-pointer" data-index="1">
        <div class="absolute -right-4 -bottom-10 text-[12rem] font-bold text-white/5 select-none pointer-events-none z-0 leading-none">02</div>
        
        <div class="relative z-10 flex flex-col h-full">
          <div class="flex flex-col md:flex-row md:items-center gap-6 mb-8">
            <div class="w-16 h-16 bg-[#1e4db7] rounded-2xl flex items-center justify-center shrink-0 shadow-lg shadow-[#1e4db7]/20">
              <span class="material-symbols-outlined text-white text-3xl">shield_lock</span>
            </div>
            <div class="flex flex-col">
              <h3 class="text-2xl md:text-4xl font-bold text-white leading-tight">Ciberseguridad Avanzada</h3>
              <p class="text-[0.7rem] md:text-[0.8rem] font-bold uppercase tracking-wider text-blue-400 mt-1">Protección 360°</p>
            </div>
          </div>

          <p class="text-slate-300 text-sm md:text-lg leading-relaxed font-light mb-8 max-w-sm">
            Implementamos perímetros de seguridad inteligentes y respuesta ante incidentes para blindar su activo más valioso.
          </p>
          
          <a href="/formulario" class="card-link inline-flex items-center gap-2 text-sm font-semibold text-blue-500 no-underline transition-all hover:gap-3">
            Solicitar Información <span class="material-symbols-outlined text-sm">arrow_forward</span>
          </a>
        </div>
      </div>

      <!-- 3. Soporte y Gestión TI -->
      <div class="card bg-[#0a1a2e]/90 backdrop-blur-xl border border-white/5 p-10 md:p-14 relative overflow-hidden cursor-pointer" data-index="2">
        <div class="absolute -right-4 -bottom-10 text-[12rem] font-bold text-white/5 select-none pointer-events-none z-0 leading-none">03</div>
        
        <div class="relative z-10 flex flex-col h-full">
          <div class="flex flex-col md:flex-row md:items-center gap-6 mb-8">
            <div class="w-16 h-16 bg-[#1e4db7] rounded-2xl flex items-center justify-center shrink-0 shadow-lg shadow-[#1e4db7]/20">
              <span class="material-symbols-outlined text-white text-3xl">support_agent</span>
            </div>
            <div class="flex flex-col">
              <h3 class="text-2xl md:text-4xl font-bold text-white leading-tight">Soporte y Gestión TI</h3>
              <p class="text-[0.7rem] md:text-[0.8rem] font-bold uppercase tracking-wider text-blue-400 mt-1">Continuidad Operativa</p>
            </div>
          </div>

          <p class="text-slate-300 text-sm md:text-lg leading-relaxed font-light mb-8 max-w-sm">
            Soporte técnico proactivo y gestión de infraestructura para que su negocio nunca se detenga.
          </p>
          
          <a href="/formulario" class="card-link inline-flex items-center gap-2 text-sm font-semibold text-blue-500 no-underline transition-all hover:gap-3">
            Solicitar Información <span class="material-symbols-outlined text-sm">arrow_forward</span>
          </a>
        </div>
      </div>

      <!-- 4. Consultoría Estratégica -->
      <div class="card bg-[#0a1a2e]/90 backdrop-blur-xl border border-white/5 p-10 md:p-14 relative overflow-hidden cursor-pointer" data-index="3">
        <div class="absolute -right-4 -bottom-10 text-[12rem] font-bold text-white/5 select-none pointer-events-none z-0 leading-none">04</div>
        
        <div class="relative z-10 flex flex-col h-full">
          <div class="flex flex-col md:flex-row md:items-center gap-6 mb-8">
            <div class="w-16 h-16 bg-[#1e4db7] rounded-2xl flex items-center justify-center shrink-0 shadow-lg shadow-[#1e4db7]/20">
              <span class="material-symbols-outlined text-white text-3xl">analytics</span>
            </div>
            <div class="flex flex-col">
              <h3 class="text-2xl md:text-4xl font-bold text-white leading-tight">Consultoría Estratégica</h3>
              <p class="text-[0.7rem] md:text-[0.8rem] font-bold uppercase tracking-wider text-blue-400 mt-1">Transformación Digital</p>
            </div>
          </div>

          <p class="text-slate-300 text-sm md:text-lg leading-relaxed font-light mb-8 max-w-sm">
            Alineamos la tecnología con sus objetivos de negocio mediante planificación estratégica.
          </p>
          
          <a href="/formulario" class="card-link inline-flex items-center gap-2 text-sm font-semibold text-blue-500 no-underline transition-all hover:gap-3">
            Solicitar Información <span class="material-symbols-outlined text-sm">arrow_forward</span>
          </a>
        </div>
      </div>

    </div>
  </div>

  <div class="carousel-controls flex items-center justify-center gap-6 mt-10">
    <button class="ctrl-btn w-12 h-12 rounded-full border border-white/20 bg-white/5 text-white flex items-center justify-center transition-all hover:bg-white hover:text-[#053D8A]" id="prev" aria-label="Anterior">
      <span class="material-symbols-outlined">chevron_left</span>
    </button>
    <div class="dots flex gap-2 items-center" id="dots"></div>
    <button class="ctrl-btn w-12 h-12 rounded-full border border-white/20 bg-white/5 text-white flex items-center justify-center transition-all hover:bg-white hover:text-[#053D8A]" id="next" aria-label="Siguiente">
      <span class="material-symbols-outlined">chevron_right</span>
    </button>
  </div>
</section>

<style>
  .carousel-wrapper {
    mask-image: linear-gradient(to right, transparent 0%, black 15%, black 85%, transparent 100%);
    -webkit-mask-image: linear-gradient(to right, transparent 0%, black 15%, black 85%, transparent 100%);
  }

  .carousel-track {
    gap: 32px;
  }

  .card {
      flex: 0 0 620px;
      max-width: 620px;
      background: linear-gradient(135deg, #0c0c0c 0%, #1a1a1a 100%);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 4rem;
      padding: 3.5rem 2.8rem 3rem;
      position: relative;
      overflow: hidden;
      box-shadow: 
        0 4px 24px rgba(0, 0, 0, 0.3),
        inset 0 1px 1px rgba(255, 255, 255, 0.05);
      cursor: pointer;
      /* Default: inactive state */
      filter: blur(4px);
      opacity: 0.4;
      transform: scale(0.85);
      transition: filter 0.6s cubic-bezier(0.4, 0, 0.2, 1), 
                  opacity 0.6s cubic-bezier(0.4, 0, 0.2, 1), 
                  transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1), 
                  box-shadow 0.6s ease;
      z-index: 1;
    }

    .card.active {
      filter: blur(0px);
      opacity: 1;
      transform: scale(1);
      box-shadow: 
        0 25px 50px -12px rgba(0, 0, 0, 0.5),
        inset 0 1px 1px rgba(255, 255, 255, 0.1);
      z-index: 10;
      border-color: rgba(255, 255, 255, 0.15);
    }

  .card.adjacent {
    filter: blur(1.5px);
    opacity: 0.6;
    transform: scale(0.95);
  }

  .dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.15);
    cursor: pointer;
    transition: all 0.3s ease;
  }

  .dot.active {
    background: #3b82f6; /* Blue active dot */
    width: 32px;
    border-radius: 5px;
  }

  /* Responsive adjustments */
  @media (max-width: 768px) {
    .card {
        flex: 0 0 340px;
        max-width: 340px;
        padding: 2.5rem !important;
    }
    .carousel-track {
        gap: 20px;
    }
  }
</style>

<script>
  const track = document.getElementById('track');
  const dotsContainer = document.getElementById('dots');
  const cards = Array.from(track?.querySelectorAll('.card') || []) as HTMLElement[];
  const prevBtn = document.getElementById('prev');
  const nextBtn = document.getElementById('next');
  
  const gap = 32; // Matched with CSS gap
  const total = cards.length;
  let current = 0;

  // Create dots
  cards.forEach((_, i) => {
    const d = document.createElement('div');
    d.className = 'dot';
    d.addEventListener('click', () => goTo(i));
    dotsContainer?.appendChild(d);
  });

  function updateCards() {
    cards.forEach((card, i) => {
      card.classList.remove('active', 'adjacent');
      if (i === current) {
        card.classList.add('active');
      } else if (Math.abs(i - current) === 1) {
        card.classList.add('adjacent');
      }
    });
    
    document.querySelectorAll('.dot').forEach((d, i) => {
        d.classList.toggle('active', i === current);
    });
  }

  function goTo(index) {
    if (index < 0 || index >= total) return;
    current = index;

    const wrapper = document.querySelector('.carousel-wrapper') as HTMLElement;
    if (!wrapper || !track || cards.length === 0) return;

    const card = cards[current];
    
    // 1. Get real visual dimensions (includes scale/transforms)
    const wrapperRect = wrapper.getBoundingClientRect();
    const cardRect = card.getBoundingClientRect();

    // 2. Read the current transform state safely
    const style = window.getComputedStyle(track);
    const matrix = new DOMMatrixReadOnly(style.transform);
    const currentTranslateX = matrix.m41;

    // 3. Calculate the visual center delta
    const wrapperCenter = wrapperRect.left + (wrapperRect.width / 2);
    const cardCenter = cardRect.left + (cardRect.width / 2);
    
    // The visual offset needed to center the card center with the wrapper center
    const offset = wrapperCenter - cardCenter;

    // 4. Apply the new translation relative to the current one
    track.style.transform = `translateX(${currentTranslateX + offset}px)`;

    updateCards();
  }

  // Initial setup
  updateCards();
  
  // Wait for layout to be stable
  setTimeout(() => {
    if (track) track.style.transition = 'none';
    goTo(current);
    setTimeout(() => {
        if (track) track.style.transition = '';
    }, 50);
  }, 100);

  window.addEventListener('resize', () => goTo(current));

  prevBtn?.addEventListener('click', () => goTo(current - 1));
  nextBtn?.addEventListener('click', () => goTo(current + 1));

  // Touch support
  let startX = 0;
  track?.addEventListener('touchstart', (e: any) => startX = e.touches[0].clientX);
  track?.addEventListener('touchend', (e: any) => {
    const diff = startX - e.changedTouches[0].clientX;
    if (Math.abs(diff) > 50) goTo(current + (diff > 0 ? 1 : -1));
  });

  // Click on cards to focus them
  cards.forEach((card, i) => {
    card.addEventListener('click', () => goTo(i));
  });
</script>
